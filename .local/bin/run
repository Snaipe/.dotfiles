#!/bin/sh

configdir="${XDG_CONFIG_HOME:-"$HOME/.config"}"/run
cachedir=${XDG_CACHE_HOME:-"$HOME/.cache"}
if [ -d "$cachedir" ]; then
    cache=$cachedir/dmenu_run
else
    cache=$HOME/.dmenu_cache # if no xdg dir, fall back to dotfile in ~
fi

select() {
    dmenu                                   \
        -fn 'Meslo LG M DZ for Powerline'   \
        -y 170 -x 150 -w 1280               \
        -p '>'                              \
        -r                                  \
        -q                                  \
        -z                                  \
        -i                                  \
        -dim 0.7                            \
        -l 22                               \
        -nb '#101010'                       \
        -nf '#cfcfcf'                       \
        -sb '#ed6666'                       \
        -sf '#000000'
}

prepend() {
    sed -e 's|^|'"$1"'|' $2
}

trimspace() {
    sed -E -e 's/^\s*//' -e 's/\s*$//'
}

actions() {
    if [ -x "$configdir/actions" ]; then
        actions=$(grep -E -o '\s*(function\s)?\s*actions_\w*\s*\(\)'    \
                "$configdir/actions"                                    \
            | sed -E -e 's/actions_(\w*)\s*\(\)/\1/g'                   \
            | sort -u)
        for a in $actions; do
            if command -V "entries_$a" >/dev/null 2>&1; then
                "entries_$a"
            else
                echo $a
            fi | prepend 'action: '
        done
        unset a;
    fi
    cat
}

apps() {
    if [ -d "/usr/share/applications/" ]; then
        for f in /usr/share/applications/?*.desktop; do
            grep -E "^Name=.*" "$f" | sed -e 's/Name=//'
        done | prepend 'app: '
        unset f
    fi
    cat
}

wm() {
    if command -v wmctrl >/dev/null; then
        wmctrl -d                                   \
            | grep -E '^[[:digit:]]+[[:space:]]*-'  \
            | grep -E -o '\w*$'                     \
            | prepend 'workspace: '
        wmctrl -l \
            | grep -E -o "$(hostname) .*$" \
            | sed -e "s/^$(hostname) //" \
            | prepend 'window: '
    fi
    cat
}

workspace_from_name() {
    wmctrl -d | grep -E "$1$" | grep -E -o '^[[:digit:]]+'
}

run() {
    IFS=''
    select="$(head -n1)"
    type="$(echo $select | cut -d: -f1)"
    val="$(echo $select | cut -d: -f2- | trimspace)"
    unset IFS

    case $type in
        action|act|a)
            eval actions_$val &;;
        run|r)
            eval $val &;;
        app)
            launch=$(grep -E "^Name=\s*$val\s*" -r "/usr/share/applications" \
                | cut -d: -f1)
            eval $(grep -E "^Exec=.*" $launch \
                | sed -e 's/^Exec=//' -e 's/%[fFuUdDnNickvm]//g') &
            ;;
        workspace|work) wmctrl -s "$(workspace_from_name $val)" &;;
        window|win) wmctrl -a "$val" &;;
    esac
}

[ -x "$configdir/actions" ] && . $configdir/actions >/dev/null 2>&1

(
    IFS=:
    if stest -dqr -n "$cache" $PATH; then
        stest -flx $PATH | sort -u > "$cache"
    fi
    unset IFS
    cat "$cache" | prepend 'run: ' | actions | apps | wm | select
) | run
